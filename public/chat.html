<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Anxiety Remedy Hub | Virtual Assistant</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <style>
      .chat-container { max-width: 920px; margin: 0 auto; padding: 40px; }
      .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
      .chat-log { border: 1px solid #e6edf5; border-radius: 16px; background: #fff; padding: 16px; height: 60vh; overflow-y: auto; box-shadow: var(--shadow-sm); }
      .msg { display: grid; grid-template-columns: 40px 1fr; gap: 12px; align-items: start; margin-bottom: 14px; }
      .msg .avatar { width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; font-weight: 800; color: #fff; }
      .msg.user .avatar { background: var(--color-accent); }
      .msg.assistant .avatar { background: var(--color-primary); }
      .bubble { background: #f7fafc; border: 1px solid #e6edf5; border-radius: 12px; padding: 12px 14px; }
      .bubble h1, .bubble h2, .bubble h3, .bubble h4, .bubble h5, .bubble h6 { margin: 0 0 8px 0; color: var(--color-primary); }
      .bubble h1 { font-size: 1.25em; } .bubble h2 { font-size: 1.2em; } .bubble h3 { font-size: 1.1em; }
      .bubble p { margin: 0 0 12px 0; line-height: 1.5; } .bubble p:last-child { margin-bottom: 0; }
      .bubble ul, .bubble ol { margin: 0 0 12px 0; padding-left: 20px; } .bubble li { margin: 4px 0; }
      .bubble code { background: #e6edf5; padding: 2px 4px; border-radius: 4px; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 0.9em; }
      .bubble pre { background: #f1f5f9; border: 1px solid #e6edf5; border-radius: 6px; padding: 12px; margin: 8px 0; overflow-x: auto; }
      .bubble pre code { background: none; padding: 0; }
      .bubble blockquote { border-left: 3px solid var(--color-accent); margin: 8px 0; padding: 4px 0 4px 12px; background: #f0f7ff; border-radius: 0 4px 4px 0; }
      .bubble strong { font-weight: 600; color: var(--color-text); }
      .bubble em { font-style: italic; }
      .bubble hr { border: none; border-top: 1px solid #e6edf5; margin: 16px 0; }
      .composer { display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-top: 16px; }
      .composer textarea { border: 1px solid #d8e3f0; border-radius: 10px; padding: 12px; font-size: 16px; min-height: 80px; }
      .subtitle { color: var(--color-text-soft); }
      .disclaimer { font-size: 14px; color: var(--color-text-soft); margin-top: 12px; }
      .link-home { text-decoration: none; color: var(--color-primary); font-weight: 700; }
      .typing-cursor { animation: blink 1s infinite; }
      @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
      .streaming-text { position: relative; }
      .streaming-text::after { content: '|'; color: var(--color-primary); animation: blink 1s infinite; }
    </style>
  </head>
  <body>
    <header class="site-header" role="banner">
      <div class="container">
        <a class="brand" href="/" aria-label="Anxiety Remedy Hub home">
          <span class="brand-mark" aria-hidden="true">AR</span>
          <span class="brand-name">Anxiety Remedy Hub</span>
        </a>
        <nav class="site-nav" aria-label="Primary">
          <ul>
            <li><a href="/#approach">Approach</a></li>
            <li><a href="/#services">Services</a></li>
            <li><a href="/#mindfulness">Mindfulness</a></li>
            <li><a class="cta" href="/#contact">Contact</a></li>
            <li><span id="visit-counter" aria-live="polite">Visitors: —</span></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="chat-container">
      <div class="chat-header">
        <div>
          <h1>Virtual Assistant</h1>
          <p class="subtitle">Friendly guidance from our anxiety relief expert, powered by AI.</p>
        </div>
        <a class="link-home" href="/">← Back to site</a>
      </div>

      <div id="chat-log" class="chat-log" aria-live="polite" aria-label="Chat log"></div>

      <div class="composer">
        <textarea id="composer" placeholder="Ask about techniques, routines, or how to handle specific situations…"></textarea>
        <button id="send" class="button primary">Send</button>
      </div>
      <p class="disclaimer">This assistant provides educational suggestions, not medical advice. If you are in crisis, contact local emergency services or a crisis hotline.</p>
    </main>

    <script>
      (function(){
        var log = document.getElementById('chat-log');
        var composer = document.getElementById('composer');
        var sendBtn = document.getElementById('send');
        var messages = [];

        function append(role, text, options) {
          options = options || {};
          var item = document.createElement('div');
          item.className = 'msg ' + role;
          var avatar = document.createElement('div');
          avatar.className = 'avatar';
          avatar.textContent = role === 'user' ? 'You' : 'AR';
          var bubble = document.createElement('div');
          bubble.className = 'bubble';
          
          // For user messages, use plain text. For assistant messages, parse markdown
          if (role === 'user') {
            bubble.textContent = text;
          } else {
            if (options.streaming) {
              bubble.textContent = text || '';
            } else {
              try {
                // Configure marked for security
                marked.use({
                  gfm: true,
                  breaks: true,
                  headerIds: false,
                  mangle: false
                });
                bubble.innerHTML = marked.parse(text || '');
              } catch (e) {
                // Fallback to plain text if markdown parsing fails
                bubble.textContent = text;
              }
            }
          }
          
          item.appendChild(avatar);
          item.appendChild(bubble);
          log.appendChild(item);
          log.scrollTop = log.scrollHeight;
          
          return bubble; // Return the bubble for streaming updates
        }

        function animateText(element, fullText, onComplete) {
          var currentText = '';
          var index = 0;
          var speed = 20; // milliseconds per character (fast animation)
          
          // Add streaming cursor effect
          element.classList.add('streaming-text');
          
          function addChar() {
            if (index < fullText.length) {
              currentText += fullText[index];
              element.textContent = currentText;
              index++;
              setTimeout(addChar, speed);
              
              // Auto-scroll as text appears
              log.scrollTop = log.scrollHeight;
            } else {
              // Animation complete, remove cursor and render markdown
              element.classList.remove('streaming-text');
              if (onComplete) onComplete();
            }
          }
          
          addChar();
        }

        function finalizeMessage(bubble, fullText) {
          // Remove streaming cursor
          bubble.classList.remove('streaming-text');
          
          try {
            marked.use({
              gfm: true,
              breaks: true,
              headerIds: false,
              mangle: false
            });
            bubble.innerHTML = marked.parse(fullText || '');
          } catch (e) {
            bubble.textContent = fullText;
          }
          log.scrollTop = log.scrollHeight;
        }

        function sendStreaming() {
          var text = (composer.value || '').trim();
          if (!text) return;
          append('user', text);
          messages.push({ role: 'user', content: text });
          composer.value = '';
          sendBtn.disabled = true;

          // Create a bubble for the assistant response
          var bubble = append('assistant', '', { streaming: true });
          var fullResponse = '';
          var currentDisplayText = '';

          // Use fetch with streaming
          fetch('/api/chat', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Accept': 'text/event-stream'
            },
            body: JSON.stringify({ messages: messages, stream: true })
          }).then(function(response) {
            if (!response.ok) {
              throw new Error('HTTP ' + response.status);
            }

            var reader = response.body.getReader();
            var decoder = new TextDecoder();

            function readStream() {
              return reader.read().then(function(result) {
                if (result.done) {
                  // Stream finished, finalize message
                  if (fullResponse) {
                    finalizeMessage(bubble, fullResponse);
                    messages.push({ role: 'assistant', content: fullResponse });
                  }
                  sendBtn.disabled = false;
                  return;
                }

                var chunk = decoder.decode(result.value, { stream: true });
                var lines = chunk.split('\n');
                
                for (var i = 0; i < lines.length; i++) {
                  var line = lines[i].trim();
                  if (line.startsWith('data: ')) {
                    var data = line.slice(6);
                    if (data === '[DONE]') {
                      // Stream complete
                      if (fullResponse) {
                        finalizeMessage(bubble, fullResponse);
                        messages.push({ role: 'assistant', content: fullResponse });
                      }
                      sendBtn.disabled = false;
                      return;
                    }
                    
                    try {
                      var parsed = JSON.parse(data);
                      if (parsed.error) {
                        throw new Error(parsed.error);
                      }
                      if (parsed.content) {
                        fullResponse += parsed.content;
                        // Animate the new content
                        animateNewContent(bubble, fullResponse, currentDisplayText);
                        currentDisplayText = fullResponse;
                      }
                    } catch (e) {
                      // Skip invalid JSON
                    }
                  }
                }

                return readStream();
              });
            }

            return readStream();
          }).catch(function(error) {
            console.error('Streaming error:', error);
            bubble.textContent = 'Network error. Please try again.';
            sendBtn.disabled = false;
          });
        }

        function animateNewContent(bubble, fullText, currentText) {
          var newContent = fullText.slice(currentText.length);
          if (!newContent) return;

          var displayText = currentText;
          var index = 0;
          var speed = 15; // Fast animation speed
          
          // Add streaming cursor effect
          bubble.classList.add('streaming-text');

          function addChar() {
            if (index < newContent.length) {
              displayText += newContent[index];
              bubble.textContent = displayText;
              index++;
              setTimeout(addChar, speed);
              
              // Auto-scroll as text appears
              log.scrollTop = log.scrollHeight;
            } else {
              // Keep cursor for streaming (will be removed when stream ends)
            }
          }
          
          addChar();
        }

        function send() {
          // Try streaming first, fallback to regular if needed
          try {
            sendStreaming();
          } catch (error) {
            sendFallback();
          }
        }

        function sendFallback() {
          var text = (composer.value || '').trim();
          if (!text) return;
          append('user', text);
          messages.push({ role: 'user', content: text });
          composer.value = '';
          sendBtn.disabled = true;
          
          fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: messages })
          }).then(function(r){
              return r.json().then(function(d){ return { ok: r.ok, status: r.status, data: d }; });
            })
            .then(function(payload){
              if (!payload.ok) {
                var msg = (payload.data && payload.data.error) ? payload.data.error : 'Request failed';
                if (payload.status === 500 && /Missing OPENROUTER_API_KEY/i.test(msg)) {
                  append('assistant', 'Server is missing its API key. Please set OPENROUTER_API_KEY in .env and restart.');
                  return;
                }
                if (payload.status === 401) {
                  append('assistant', 'Auth failed with the model provider. Please check the server API key.');
                  return;
                }
                append('assistant', 'Something went wrong. Please try again.');
                return;
              }
              var data = payload.data || {};
              var reply = data.content || 'Sorry, something went wrong.';
              
              // Animate the response
              var bubble = append('assistant', '', { streaming: true });
              animateText(bubble, reply, function() {
                finalizeMessage(bubble, reply);
                messages.push({ role: 'assistant', content: reply });
              });
            })
            .catch(function(){ append('assistant', 'Network error. Please try again.'); })
            .finally(function(){ sendBtn.disabled = false; });
        }

        sendBtn.addEventListener('click', send);
        composer.addEventListener('keydown', function(e){
          if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'enter') {
            e.preventDefault();
            send();
          }
        });

        // Warm greeting with animation
        var greetingText = 'Hi, I\'m your Anxiety Remedy Hub assistant. How can I help today? I can suggest evidence-based techniques and simple routines. For personalized guidance, feel free to get in touch with our experts at Anxiety Remedy Hub via the Contact section or email sagarwalajmer@gmail.com.';
        var bubble = append('assistant', '', { streaming: true });
        animateText(bubble, greetingText, function() {
          finalizeMessage(bubble, greetingText);
        });

        // Visits: increment once per day per device
        (function visitCounter(){
          var KEY = 'arh-visit-date';
          var today = new Date().toISOString().slice(0,10);
          var last = localStorage.getItem(KEY);
          function setCount(n){ var el = document.getElementById('visit-counter'); if (el) el.textContent = 'Visitors: ' + n; }
          fetch('/api/visits').then(function(r){ return r.json(); }).then(function(d){ setCount(d && d.count || 0); }).catch(function(){});
          if (last !== today) {
            fetch('/api/visits', { method: 'POST' }).then(function(r){ return r.json(); }).then(function(d){ setCount(d && d.count || 0); localStorage.setItem(KEY, today); }).catch(function(){});
          }
        })();
      })();
    </script>
  </body>
  </html>


